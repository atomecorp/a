<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ Automated Region Loop Tests</title>
    <style>
        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            margin: 0;
            padding: 20px;
            color: white;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .test-item {
            margin: 15px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            border-left: 4px solid #ffc107;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .test-item.passed {
            border-left-color: #28a745;
        }
        
        .test-item.failed {
            border-left-color: #dc3545;
        }
        
        .test-status {
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 4px;
            min-width: 80px;
            text-align: center;
        }
        
        .status-pending {
            background: #ffc107;
            color: #212529;
        }
        
        .status-passed {
            background: #28a745;
            color: white;
        }
        
        .status-failed {
            background: #dc3545;
            color: white;
        }
        
        .progress-bar {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            height: 20px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            background: linear-gradient(90deg, #28a745, #20c997);
            height: 100%;
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .control-panel {
            text-align: center;
            margin: 30px 0;
        }
        
        .btn {
            background: linear-gradient(145deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin: 0 10px;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 123, 255, 0.3);
        }
        
        .wavesurfer-container {
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
        }
        
        .log {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü§ñ Automated Intelligent Region Loop Tests</h1>
        
        <div class="progress-bar">
            <div class="progress-fill" id="progressBar"></div>
        </div>
        
        <div id="testResults">
            <div class="test-item" id="test-init">
                <span>üéµ WaveSurfer Initialization</span>
                <span class="test-status status-pending">PENDING</span>
            </div>
            <div class="test-item" id="test-regions">
                <span>üéØ Region Creation & Detection</span>
                <span class="test-status status-pending">PENDING</span>
            </div>
            <div class="test-item" id="test-events">
                <span>üì° Region Events (in/out/looped)</span>
                <span class="test-status status-pending">PENDING</span>
            </div>
            <div class="test-item" id="test-auto-loop">
                <span>üîÑ Automatic Region Loop</span>
                <span class="test-status status-pending">PENDING</span>
            </div>
            <div class="test-item" id="test-manual-control">
                <span>üéÆ Manual Loop Control</span>
                <span class="test-status status-pending">PENDING</span>
            </div>
            <div class="test-item" id="test-region-switching">
                <span>üîÑ Region Switching</span>
                <span class="test-status status-pending">PENDING</span>
            </div>
            <div class="test-item" id="test-api">
                <span>üîß API Method Validation</span>
                <span class="test-status status-pending">PENDING</span>
            </div>
        </div>
        
        <div class="wavesurfer-container">
            <div id="wavesurfer-auto"></div>
        </div>
        
        <div class="control-panel">
            <button class="btn" onclick="runAllTests()">üöÄ Run All Tests</button>
            <button class="btn" onclick="resetTests()">üîÑ Reset Tests</button>
            <button class="btn" onclick="showReport()">üìä Show Report</button>
        </div>
        
        <div class="log" id="testLog">
            ü§ñ Automated testing system initialized...<br>
        </div>
    </div>

    <script type="module">
        import { WaveSurfer } from './src/a/components/WaveSurfer.js';
        
        let wavesurfer = null;
        let testState = {
            init: false,
            regions: false,
            events: { regionIn: false, regionOut: false, regionLooped: false },
            autoLoop: false,
            manualControl: false,
            regionSwitching: false,
            api: false
        };
        
        let eventCount = { regionIn: 0, regionOut: 0, regionLooped: 0 };
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'info' ? '‚ÑπÔ∏è' : 'ü§ñ';
            logDiv.innerHTML += `<span>[${timestamp}] ${icon} ${message}</span><br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function updateTestStatus(testId, status) {
            const testItem = document.getElementById(`test-${testId}`);
            const statusSpan = testItem.querySelector('.test-status');
            
            testItem.classList.remove('passed', 'failed');
            statusSpan.classList.remove('status-pending', 'status-passed', 'status-failed');
            
            if (status === 'passed') {
                testItem.classList.add('passed');
                statusSpan.classList.add('status-passed');
                statusSpan.textContent = 'PASSED';
            } else if (status === 'failed') {
                testItem.classList.add('failed');
                statusSpan.classList.add('status-failed');
                statusSpan.textContent = 'FAILED';
            } else {
                statusSpan.classList.add('status-pending');
                statusSpan.textContent = 'PENDING';
            }
            
            updateProgress();
        }
        
        function updateProgress() {
            const tests = Object.keys(testState);
            let passed = 0;
            
            tests.forEach(test => {
                if (test === 'events') {
                    if (testState.events.regionIn && testState.events.regionOut && testState.events.regionLooped) {
                        passed++;
                    }
                } else if (testState[test]) {
                    passed++;
                }
            });
            
            const percentage = (passed / tests.length) * 100;
            document.getElementById('progressBar').style.width = `${percentage}%`;
            
            log(`Progress: ${passed}/${tests.length} tests passed (${percentage.toFixed(1)}%)`, 'info');
        }
        
        async function initWaveSurfer() {
            try {
                log('üéµ Initializing WaveSurfer...', 'info');
                
                wavesurfer = new WaveSurfer({
                    url: './src/assets/audios/sample-audio.mp3',
                    waveColor: '#4A90E2',
                    progressColor: '#2ECC71',
                    regions: { enabled: true },
                    controls: { enabled: true, loop: true }
                });
                
                await wavesurfer.attachTo('#wavesurfer-auto');
                
                // Set up event listeners
                setupEventListeners();
                
                testState.init = true;
                updateTestStatus('init', 'passed');
                log('‚úÖ WaveSurfer initialized successfully', 'success');
                
                return true;
            } catch (error) {
                log(`‚ùå WaveSurfer initialization failed: ${error.message}`, 'error');
                updateTestStatus('init', 'failed');
                return false;
            }
        }
        
        function setupEventListeners() {
            wavesurfer.addEventListener('region-in', (event) => {
                eventCount.regionIn++;
                testState.events.regionIn = true;
                log(`üéØ REGION-IN event #${eventCount.regionIn}: ${event.detail.region.id}`, 'success');
                checkEventsComplete();
            });
            
            wavesurfer.addEventListener('region-out', (event) => {
                eventCount.regionOut++;
                testState.events.regionOut = true;
                log(`üéØ REGION-OUT event #${eventCount.regionOut}: ${event.detail.region.id}`, 'success');
                checkEventsComplete();
            });
            
            wavesurfer.addEventListener('region-looped', (event) => {
                eventCount.regionLooped++;
                testState.events.regionLooped = true;
                testState.autoLoop = true;
                log(`üîÅ REGION-LOOPED event #${eventCount.regionLooped}: ${event.detail.region.id}`, 'success');
                updateTestStatus('auto-loop', 'passed');
                checkEventsComplete();
            });
        }
        
        function checkEventsComplete() {
            if (testState.events.regionIn && testState.events.regionOut && testState.events.regionLooped) {
                updateTestStatus('events', 'passed');
                log('‚úÖ All region events validated', 'success');
            }
        }
        
        async function testRegionCreation() {
            try {
                log('üéØ Testing region creation...', 'info');
                
                const duration = wavesurfer.getDuration();
                const regions = [
                    { start: duration * 0.1, end: duration * 0.3, id: 'test-intro' },
                    { start: duration * 0.4, end: duration * 0.6, id: 'test-middle' },
                    { start: duration * 0.7, end: duration * 0.9, id: 'test-outro' }
                ];
                
                for (const region of regions) {
                    await wavesurfer.addRegion(region);
                }
                
                // Validate regions were created
                if (wavesurfer.regions.size >= 3) {
                    testState.regions = true;
                    updateTestStatus('regions', 'passed');
                    log('‚úÖ Regions created and detected successfully', 'success');
                } else {
                    updateTestStatus('regions', 'failed');
                    log('‚ùå Region creation failed', 'error');
                }
                
            } catch (error) {
                log(`‚ùå Region creation test failed: ${error.message}`, 'error');
                updateTestStatus('regions', 'failed');
            }
        }
        
        async function testAutoLoop() {
            try {
                log('üîÑ Testing automatic region loop...', 'info');
                
                // Enable loop and jump to first region
                wavesurfer.toggleLoop();
                const duration = wavesurfer.getDuration();
                wavesurfer.seekTo((duration * 0.15) / duration);
                
                // Start playback
                await wavesurfer.play();
                
                log('‚úÖ Auto-loop test initiated - waiting for region-looped event', 'success');
                
                // Stop after a short time
                setTimeout(() => {
                    wavesurfer.pause();
                }, 3000);
                
            } catch (error) {
                log(`‚ùå Auto-loop test failed: ${error.message}`, 'error');
                updateTestStatus('auto-loop', 'failed');
            }
        }
        
        function testManualControl() {
            try {
                log('üéÆ Testing manual loop control...', 'info');
                
                // Test API methods
                wavesurfer.loopCurrentRegion();
                if (wavesurfer.loopRegion) {
                    log('‚úÖ loopCurrentRegion() working', 'success');
                }
                
                wavesurfer.clearLoopRegion();
                if (!wavesurfer.loopRegion) {
                    log('‚úÖ clearLoopRegion() working', 'success');
                }
                
                testState.manualControl = true;
                updateTestStatus('manual-control', 'passed');
                log('‚úÖ Manual control test passed', 'success');
                
            } catch (error) {
                log(`‚ùå Manual control test failed: ${error.message}`, 'error');
                updateTestStatus('manual-control', 'failed');
            }
        }
        
        function testRegionSwitching() {
            try {
                log('üîÑ Testing region switching...', 'info');
                
                const duration = wavesurfer.getDuration();
                const positions = [
                    duration * 0.2,  // First region
                    duration * 0.5,  // Second region
                    duration * 0.8   // Third region
                ];
                
                let switchCount = 0;
                const switchInterval = setInterval(() => {
                    if (switchCount >= positions.length) {
                        clearInterval(switchInterval);
                        testState.regionSwitching = true;
                        updateTestStatus('region-switching', 'passed');
                        log('‚úÖ Region switching test completed', 'success');
                        return;
                    }
                    
                    wavesurfer.seekTo(positions[switchCount] / duration);
                    log(`üîÑ Switched to position ${positions[switchCount].toFixed(2)}s`, 'info');
                    switchCount++;
                }, 1000);
                
            } catch (error) {
                log(`‚ùå Region switching test failed: ${error.message}`, 'error');
                updateTestStatus('region-switching', 'failed');
            }
        }
        
        function testAPI() {
            try {
                log('üîß Testing API methods...', 'info');
                
                const apiMethods = [
                    'toggleLoop',
                    'setLoopRegion',
                    'clearLoopRegion',
                    'loopCurrentRegion',
                    'getActiveRegionAt',
                    'handleRegionLoop',
                    'updateActiveRegion'
                ];
                
                let methodsPassed = 0;
                apiMethods.forEach(method => {
                    if (typeof wavesurfer[method] === 'function') {
                        methodsPassed++;
                        log(`‚úÖ ${method}() available`, 'success');
                    } else {
                        log(`‚ùå ${method}() missing`, 'error');
                    }
                });
                
                if (methodsPassed === apiMethods.length) {
                    testState.api = true;
                    updateTestStatus('api', 'passed');
                    log('‚úÖ All API methods validated', 'success');
                } else {
                    updateTestStatus('api', 'failed');
                    log(`‚ùå API validation failed: ${methodsPassed}/${apiMethods.length} methods found`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå API test failed: ${error.message}`, 'error');
                updateTestStatus('api', 'failed');
            }
        }
        
        window.runAllTests = async function() {
            log('üöÄ Starting automated test suite...', 'info');
            resetTests();
            
            if (await initWaveSurfer()) {
                await new Promise(resolve => setTimeout(resolve, 1000));
                await testRegionCreation();
                await new Promise(resolve => setTimeout(resolve, 1000));
                testAPI();
                await new Promise(resolve => setTimeout(resolve, 500));
                testManualControl();
                await new Promise(resolve => setTimeout(resolve, 500));
                testRegionSwitching();
                await new Promise(resolve => setTimeout(resolve, 2000));
                await testAutoLoop();
            }
        };
        
        window.resetTests = function() {
            testState = {
                init: false,
                regions: false,
                events: { regionIn: false, regionOut: false, regionLooped: false },
                autoLoop: false,
                manualControl: false,
                regionSwitching: false,
                api: false
            };
            eventCount = { regionIn: 0, regionOut: 0, regionLooped: 0 };
            
            ['init', 'regions', 'events', 'auto-loop', 'manual-control', 'region-switching', 'api'].forEach(test => {
                updateTestStatus(test, 'pending');
            });
            
            document.getElementById('testLog').innerHTML = 'ü§ñ Tests reset...<br>';
            log('üîÑ Test state reset', 'info');
        };
        
        window.showReport = function() {
            const totalTests = 7;
            let passedTests = 0;
            
            Object.keys(testState).forEach(test => {
                if (test === 'events') {
                    if (testState.events.regionIn && testState.events.regionOut && testState.events.regionLooped) {
                        passedTests++;
                    }
                } else if (testState[test]) {
                    passedTests++;
                }
            });
            
            const report = {
                totalTests,
                passedTests,
                failedTests: totalTests - passedTests,
                successRate: ((passedTests / totalTests) * 100).toFixed(1),
                eventCounts: eventCount,
                timestamp: new Date().toISOString()
            };
            
            log('üìä TEST REPORT:', 'info');
            log(`   Success Rate: ${report.successRate}%`, 'info');
            log(`   Passed: ${report.passedTests}/${report.totalTests}`, 'info');
            log(`   Events: RegionIn(${eventCount.regionIn}) RegionOut(${eventCount.regionOut}) RegionLooped(${eventCount.regionLooped})`, 'info');
            
            console.log('üéµ Intelligent Region Loop Test Report:', report);
        };
        
        // Global access for debugging
        window.wavesurfer = () => wavesurfer;
        window.testState = testState;
        
        // Auto-start tests after a brief delay
        setTimeout(() => {
            log('ü§ñ Auto-starting tests in 2 seconds...', 'info');
            setTimeout(runAllTests, 2000);
        }, 1000);
    </script>
</body>
</html>
