function t(t,n,a,d){return new(a=a||Promise)(function(e,i){function s(t){try{o(d.next(t))}catch(t){i(t)}}function r(t){try{o(d.throw(t))}catch(t){i(t)}}function o(t){var i;t.done?e(t.value):((i=t.value)instanceof a?i:new a(function(t){t(i)})).then(s,r)}o((d=d.apply(t,n||[])).next())})}class i{constructor(){this.listeners={}}on(t,i,e){if(this.listeners[t]||(this.listeners[t]=new Set),this.listeners[t].add(i),null!=e&&e.once){const e=()=>{this.un(t,e),this.un(t,i)};return this.on(t,e),e}return()=>this.un(t,i)}un(t,i){null!=(t=this.listeners[t])&&t.delete(i)}once(t,i){return this.on(t,i,{once:!0})}unAll(){this.listeners={}}emit(t,...i){this.listeners[t]&&this.listeners[t].forEach(t=>t(...i))}}class e extends i{constructor(t){super(),this.subscriptions=[],this.isDestroyed=!1,this.options=t}onInit(){}_init(t){this.isDestroyed&&(this.subscriptions=[],this.isDestroyed=!1),this.wavesurfer=t,this.onInit()}destroy(){this.emit("destroy"),this.subscriptions.forEach(t=>t()),this.subscriptions=[],this.isDestroyed=!0,this.wavesurfer=void 0}}class s extends i{constructor(){super(...arguments),this.unsubscribe=()=>{}}start(){this.unsubscribe=this.on("tick",()=>{requestAnimationFrame(()=>{this.emit("tick")})}),this.emit("tick")}stop(){this.unsubscribe()}destroy(){this.unsubscribe()}}const o=["audio/webm","audio/wav","audio/mpeg","audio/mp4","audio/mp3"];class r extends e{constructor(t){var i;super(Object.assign(Object.assign({},t),{audioBitsPerSecond:null!=(i=t.audioBitsPerSecond)?i:128e3,scrollingWaveform:null!=(i=t.scrollingWaveform)&&i,scrollingWaveformWindow:null!=(i=t.scrollingWaveformWindow)?i:5,continuousWaveform:null!=(i=t.continuousWaveform)&&i,renderRecordedAudio:null==(i=t.renderRecordedAudio)||i,mediaRecorderTimeslice:null!=(i=t.mediaRecorderTimeslice)?i:void 0})),this.stream=null,this.mediaRecorder=null,this.dataWindow=null,this.isWaveformPaused=!1,this.lastStartTime=0,this.lastDuration=0,this.duration=0,this.timer=new s,this.subscriptions.push(this.timer.on("tick",()=>{var t=performance.now()-this.lastStartTime;this.duration=this.isPaused()?this.duration:this.lastDuration+t,this.emit("record-progress",this.duration)}))}static create(t){return new r(t||{})}renderMicStream(t){const s=new AudioContext,i=s.createMediaStreamSource(t),r=s.createAnalyser(),o=(i.connect(r),this.options.continuousWaveform&&(r.fftSize=32),r.frequencyBinCount),n=new Float32Array(o);let a=0;this.wavesurfer&&(null==this.originalOptions&&(this.originalOptions=Object.assign({},this.wavesurfer.options)),this.wavesurfer.options.interact=!1,this.options.scrollingWaveform&&(this.wavesurfer.options.cursorWidth=0));const e=setInterval(()=>{var t,i,e;if(!this.isWaveformPaused){if(r.getFloatTimeDomainData(n),this.options.scrollingWaveform){const t=Math.floor((this.options.scrollingWaveformWindow||0)*s.sampleRate),e=Math.min(t,this.dataWindow?this.dataWindow.length+o:o),i=new Float32Array(t);if(this.dataWindow){const s=Math.max(0,t-this.dataWindow.length);i.set(this.dataWindow.slice(-e+o),s)}i.set(n,t-o),this.dataWindow=i}else if(this.options.continuousWaveform){if(!this.dataWindow){const s=this.options.continuousWaveformDuration?Math.round(100*this.options.continuousWaveformDuration):(null!=(e=null==(t=this.wavesurfer)?void 0:t.getWidth())?e:0)*window.devicePixelRatio;this.dataWindow=new Float32Array(s)}let i=0;for(let t=0;t<o;t++){const e=Math.abs(n[t]);e>i&&(i=e)}if(a+1>this.dataWindow.length){const t=new Float32Array(2*this.dataWindow.length);t.set(this.dataWindow,0),this.dataWindow=t}this.dataWindow[a]=i,a++}else this.dataWindow=n;if(this.wavesurfer){const t=(null!=(e=null==(i=this.dataWindow)?void 0:i.length)?e:0)/100;this.wavesurfer.load("",[this.dataWindow],this.options.scrollingWaveform?this.options.scrollingWaveformWindow:t).then(()=>{this.wavesurfer&&this.options.continuousWaveform&&(this.wavesurfer.setTime(this.getDuration()/1e3),this.wavesurfer.options.minPxPerSec||this.wavesurfer.setOptions({minPxPerSec:this.wavesurfer.getWidth()/this.wavesurfer.getDuration()}))}).catch(t=>{console.error("Error rendering real-time recording data:",t)})}}},10);return{onDestroy:()=>{clearInterval(e),null!=i&&i.disconnect(),null!=s&&s.close()},onEnd:()=>{this.isWaveformPaused=!0,clearInterval(e),this.stopMic()}}}startMic(s){return t(this,void 0,void 0,function*(){let t;try{t=yield navigator.mediaDevices.getUserMedia({audio:null==s||s})}catch(t){throw new Error("Error accessing the microphone: "+t.message)}var{onDestroy:i,onEnd:e}=this.renderMicStream(t);return this.subscriptions.push(this.once("destroy",i)),this.subscriptions.push(this.once("record-end",e)),this.stream=t})}stopMic(){this.stream&&(this.stream.getTracks().forEach(t=>t.stop()),this.stream=null,this.mediaRecorder=null)}startRecording(r){return t(this,void 0,void 0,function*(){var t=this.stream||(yield this.startMic(r));this.dataWindow=null;const e=this.mediaRecorder||new MediaRecorder(t,{mimeType:this.options.mimeType||o.find(t=>MediaRecorder.isTypeSupported(t)),audioBitsPerSecond:this.options.audioBitsPerSecond}),s=(this.mediaRecorder=e,this.stopRecording(),[]),i=(e.ondataavailable=t=>{0<t.data.size&&s.push(t.data),this.emit("record-data-available",t.data)},t=>{var i=new Blob(s,{type:e.mimeType});this.emit(t,i),this.options.renderRecordedAudio&&(this.applyOriginalOptionsIfNeeded(),null!=(t=this.wavesurfer)&&t.load(URL.createObjectURL(i)))});e.onpause=()=>i("record-pause"),e.onstop=()=>i("record-end"),e.start(this.options.mediaRecorderTimeslice),this.lastStartTime=performance.now(),this.lastDuration=0,this.duration=0,this.isWaveformPaused=!1,this.timer.start(),this.emit("record-start")})}getDuration(){return this.duration}isRecording(){var t;return"recording"===(null==(t=this.mediaRecorder)?void 0:t.state)}isPaused(){var t;return"paused"===(null==(t=this.mediaRecorder)?void 0:t.state)}isActive(){var t;return"inactive"!==(null==(t=this.mediaRecorder)?void 0:t.state)}stopRecording(){var t;this.isActive()&&(null!=(t=this.mediaRecorder)&&t.stop(),this.timer.stop())}pauseRecording(){var t;this.isRecording()&&(this.isWaveformPaused=!0,null!=(t=this.mediaRecorder)&&t.requestData(),null!=(t=this.mediaRecorder)&&t.pause(),this.timer.stop(),this.lastDuration=this.duration)}resumeRecording(){var t;this.isPaused()&&(this.isWaveformPaused=!1,null!=(t=this.mediaRecorder)&&t.resume(),this.timer.start(),this.lastStartTime=performance.now(),this.emit("record-resume"))}static getAvailableAudioDevices(){return t(this,void 0,void 0,function*(){return navigator.mediaDevices.enumerateDevices().then(t=>t.filter(t=>"audioinput"===t.kind))})}destroy(){this.applyOriginalOptionsIfNeeded(),super.destroy(),this.stopRecording(),this.stopMic()}applyOriginalOptionsIfNeeded(){this.wavesurfer&&this.originalOptions&&(this.wavesurfer.setOptions(this.originalOptions),delete this.originalOptions)}}export{r as default};