class t{constructor(){this.listeners={}}on(t,e,i){if(this.listeners[t]||(this.listeners[t]=new Set),this.listeners[t].add(e),null!=i&&i.once){const i=()=>{this.un(t,i),this.un(t,e)};return this.on(t,i),i}return()=>this.un(t,e)}un(t,e){null!=(t=this.listeners[t])&&t.delete(e)}once(t,e){return this.on(t,e,{once:!0})}unAll(){this.listeners={}}emit(t,...e){this.listeners[t]&&this.listeners[t].forEach(t=>t(...e))}}class e extends t{constructor(t){super(),this.subscriptions=[],this.isDestroyed=!1,this.options=t}onInit(){}_init(t){this.isDestroyed&&(this.subscriptions=[],this.isDestroyed=!1),this.wavesurfer=t,this.onInit()}destroy(){this.emit("destroy"),this.subscriptions.forEach(t=>t()),this.subscriptions=[],this.isDestroyed=!0,this.wavesurfer=void 0}}function i(d,u,c,g,p=3,r=0,m=100){if(!d)return()=>{};const v=matchMedia("(pointer: coarse)").matches;let f=()=>{};const t=t=>{if(t.button===r){t.preventDefault(),t.stopPropagation();let r=t.clientX,o=t.clientY,a=!1;const h=Date.now(),e=t=>{if(t.preventDefault(),t.stopPropagation(),!(v&&Date.now()-h<m)){var e=t.clientX,i=t.clientY,n=e-r,s=i-o;if(a||Math.abs(n)>p||Math.abs(s)>p){const t=d.getBoundingClientRect(),{left:p,top:m}=t;a||(null!=c&&c(r-p,o-m),a=!0),u(n,s,e-p,i-m),r=e,o=i}}},i=t=>{var e,i,n;a&&(e=t.clientX,t=t.clientY,{left:i,top:n}=d.getBoundingClientRect(),null!=g&&g(e-i,t-n)),f()},n=t=>{t.relatedTarget&&t.relatedTarget!==document.documentElement||i(t)},s=t=>{a&&(t.stopPropagation(),t.preventDefault())},l=t=>{a&&t.preventDefault()};document.addEventListener("pointermove",e),document.addEventListener("pointerup",i),document.addEventListener("pointerout",n),document.addEventListener("pointercancel",n),document.addEventListener("touchmove",l,{passive:!1}),document.addEventListener("click",s,{capture:!0}),f=()=>{document.removeEventListener("pointermove",e),document.removeEventListener("pointerup",i),document.removeEventListener("pointerout",n),document.removeEventListener("pointercancel",n),document.removeEventListener("touchmove",l),setTimeout(()=>{document.removeEventListener("click",s,{capture:!0})},10)}}};return d.addEventListener("pointerdown",t),()=>{f(),d.removeEventListener("pointerdown",t)}}function n(t,e){const i=e.xmlns?document.createElementNS(e.xmlns,t):document.createElement(t);for(const[t,s]of Object.entries(e))if("children"===t&&s)for(const[t,e]of Object.entries(s))e instanceof Node?i.appendChild(e):"string"==typeof e?i.appendChild(document.createTextNode(e)):i.appendChild(n(t,e));else"style"===t?Object.assign(i.style,s):"textContent"===t?i.textContent=s:i.setAttribute(t,s.toString());return i}function s(t,e,i){t=n(t,e||{});return null!=i&&i.appendChild(t),t}class r extends t{constructor(t,e,i=0){super(),this.totalDuration=e,this.numberOfChannels=i,this.element=null,this.minLength=0,this.maxLength=1/0,this.contentEditable=!1,this.subscriptions=[],this.isRemoved=!1,this.subscriptions=[],this.id=t.id||"region-"+Math.random().toString(32).slice(2),this.start=this.clampPosition(t.start),this.end=this.clampPosition(null!=(e=t.end)?e:t.start),this.drag=null==(i=t.drag)||i,this.resize=null==(e=t.resize)||e,this.resizeStart=null==(i=t.resizeStart)||i,this.resizeEnd=null==(e=t.resizeEnd)||e,this.color=null!=(i=t.color)?i:"rgba(0, 0, 0, 0.1)",this.minLength=null!=(e=t.minLength)?e:this.minLength,this.maxLength=null!=(i=t.maxLength)?i:this.maxLength,this.channelIdx=null!=(e=t.channelIdx)?e:-1,this.contentEditable=null!=(i=t.contentEditable)?i:this.contentEditable,this.element=this.initElement(),this.setContent(t.content),this.setPart(),this.renderPosition(),this.initMouseEvents()}clampPosition(t){return Math.max(0,Math.min(this.totalDuration,t))}setPart(){var t,e=this.start===this.end;null!=(t=this.element)&&t.setAttribute("part",`${e?"marker":"region"} `+this.id)}addResizeHandles(t){var e={position:"absolute",zIndex:"2",width:"6px",height:"100%",top:"0",cursor:"ew-resize",wordBreak:"keep-all"},n=s("div",{part:"region-handle region-handle-left",style:Object.assign(Object.assign({},e),{left:"0",borderLeft:"2px solid rgba(0, 0, 0, 0.5)",borderRadius:"2px 0 0 2px"})},t),e=s("div",{part:"region-handle region-handle-right",style:Object.assign(Object.assign({},e),{right:"0",borderRight:"2px solid rgba(0, 0, 0, 0.5)",borderRadius:"0 2px 2px 0"})},t);this.subscriptions.push(i(n,t=>this.onResize(t,"start"),()=>null,()=>this.onEndResizing(),1),i(e,t=>this.onResize(t,"end"),()=>null,()=>this.onEndResizing(),1))}removeResizeHandles(t){var e=t.querySelector('[part*="region-handle-left"]'),i=t.querySelector('[part*="region-handle-right"]');e&&t.removeChild(e),i&&t.removeChild(i)}initElement(){if(this.isRemoved)return null;var t=this.start===this.end;let e=0,i=100;0<=this.channelIdx&&this.channelIdx<this.numberOfChannels&&(i=100/this.numberOfChannels,e=i*this.channelIdx);var n=s("div",{style:{position:"absolute",top:e+"%",height:i+"%",backgroundColor:t?"none":this.color,borderLeft:t?"2px solid "+this.color:"none",borderRadius:"2px",boxSizing:"border-box",transition:"background-color 0.2s ease",cursor:this.drag?"grab":"default",pointerEvents:"all"}});return!t&&this.resize&&this.addResizeHandles(n),n}renderPosition(){var t,e;this.element&&(t=this.start/this.totalDuration,e=(this.totalDuration-this.end)/this.totalDuration,this.element.style.left=100*t+"%",this.element.style.right=100*e+"%")}toggleCursor(t){var e;this.drag&&null!=(e=this.element)&&e.style&&(this.element.style.cursor=t?"grabbing":"grab")}initMouseEvents(){const t=this["element"];t&&(t.addEventListener("click",t=>this.emit("click",t)),t.addEventListener("mouseenter",t=>this.emit("over",t)),t.addEventListener("mouseleave",t=>this.emit("leave",t)),t.addEventListener("dblclick",t=>this.emit("dblclick",t)),t.addEventListener("pointerdown",()=>this.toggleCursor(!0)),t.addEventListener("pointerup",()=>this.toggleCursor(!1)),this.subscriptions.push(i(t,t=>this.onMove(t),()=>this.toggleCursor(!0),()=>{this.toggleCursor(!1),this.drag&&this.emit("update-end")})),this.contentEditable&&this.content&&(this.content.addEventListener("click",t=>this.onContentClick(t)),this.content.addEventListener("blur",()=>this.onContentBlur())))}_onUpdate(t,e){var i,n;null!=(i=this.element)&&i.parentElement&&(i=this.element.parentElement.getBoundingClientRect()["width"],t=t/i*this.totalDuration,i=e&&"start"!==e?this.start:this.start+t,n=(t=e&&"end"!==e?this.end:this.end+t)-i,0<=i&&t<=this.totalDuration&&i<=t&&n>=this.minLength&&n<=this.maxLength&&(this.start=i,this.end=t,this.renderPosition(),this.emit("update",e)))}onMove(t){this.drag&&this._onUpdate(t)}onResize(t,e){!this.resize||!this.resizeStart&&"start"===e||!this.resizeEnd&&"end"===e||this._onUpdate(t,e)}onEndResizing(){this.resize&&this.emit("update-end")}onContentClick(t){t.stopPropagation(),t.target.focus(),this.emit("click",t)}onContentBlur(){this.emit("update-end")}_setTotalDuration(t){this.totalDuration=t,this.renderPosition()}play(t){this.emit("play",t&&this.end!==this.start?this.end:void 0)}getContent(t=!1){return t?this.content||void 0:this.element instanceof HTMLElement?(null==(t=this.content)?void 0:t.innerHTML)||void 0:""}setContent(t){var e;if(this.element)if(null!=(e=this.content)&&e.remove(),t){if("string"==typeof t){const e=this.start===this.end;this.content=s("div",{style:{padding:`0.2em ${e?.2:.4}em`,display:"inline-block"},textContent:t})}else this.content=t;this.contentEditable&&(this.content.contentEditable="true"),this.content.setAttribute("part","region-content"),this.element.appendChild(this.content),this.emit("content-changed")}else this.content=void 0}setOptions(t){var e,i;if(this.element){if(t.color&&(this.color=t.color,this.element.style.backgroundColor=this.color),void 0!==t.drag&&(this.drag=t.drag,this.element.style.cursor=this.drag?"grab":"default"),void 0===t.start&&void 0===t.end||(i=this.start===this.end,this.start=this.clampPosition(null!=(e=t.start)?e:this.start),this.end=this.clampPosition(null!=(e=t.end)?e:i?this.start:this.end),this.renderPosition(),this.setPart()),t.content&&this.setContent(t.content),t.id&&(this.id=t.id,this.setPart()),void 0!==t.resize&&t.resize!==this.resize){const e=this.start===this.end;this.resize=t.resize,this.resize&&!e?this.addResizeHandles(this.element):this.removeResizeHandles(this.element)}void 0!==t.resizeStart&&(this.resizeStart=t.resizeStart),void 0!==t.resizeEnd&&(this.resizeEnd=t.resizeEnd)}}remove(){this.isRemoved=!0,this.emit("remove"),this.subscriptions.forEach(t=>t()),this.element&&(this.element.remove(),this.element=null)}}class o extends e{constructor(t){super(t),this.regions=[],this.regionsContainer=this.initRegionsContainer()}static create(t){return new o(t)}onInit(){if(!this.wavesurfer)throw Error("WaveSurfer is not initialized");this.wavesurfer.getWrapper().appendChild(this.regionsContainer);let n=[];this.subscriptions.push(this.wavesurfer.on("timeupdate",e=>{const i=this.regions.filter(t=>t.start<=e&&(t.end===t.start?t.start+.05:t.end)>=e);i.forEach(t=>{n.includes(t)||this.emit("region-in",t)}),n.forEach(t=>{i.includes(t)||this.emit("region-out",t)}),n=i}))}initRegionsContainer(){return s("div",{style:{position:"absolute",top:"0",left:"0",width:"100%",height:"100%",zIndex:"5",pointerEvents:"none"}})}getRegions(){return this.regions}avoidOverlapping(n){n.content&&setTimeout(()=>{const t=n.content,e=t.getBoundingClientRect(),i=this.regions.map(t=>{if(t===n||!t.content)return 0;t=t.content.getBoundingClientRect();return e.left<t.left+t.width&&t.left<e.left+e.width?t.height:0}).reduce((t,e)=>t+e,0);t.style.marginTop=i+"px"},10)}adjustScroll(t){var e,i,n;if(t.element){const s=null==(e=null==(e=this.wavesurfer)?void 0:e.getWrapper())?void 0:e.parentElement;s&&({clientWidth:e,scrollWidth:i}=s,i<=e||(i=s.getBoundingClientRect(),n=(t=t.element.getBoundingClientRect()).left-i.left,t=t.right-i.left,n<0?s.scrollLeft+=n:e<t&&(s.scrollLeft+=t-e)))}}virtualAppend(r,o,a){const i=()=>{var t,e,i,n,s;this.wavesurfer&&(t=this.wavesurfer.getWidth(),e=this.wavesurfer.getScroll(),i=o.clientWidth,s=this.wavesurfer.getDuration(),(s=(n=Math.round(r.start/s*i))+(Math.round((r.end-r.start)/s*i)||1)>e&&n<e+t)&&!a.parentElement?o.appendChild(a):!s&&a.parentElement&&a.remove())};setTimeout(()=>{var t,e;this.wavesurfer&&r.element&&(i(),t=this.wavesurfer.on("scroll",i),e=this.wavesurfer.on("zoom",i),this.subscriptions.push(r.once("remove",t),t),this.subscriptions.push(r.once("remove",e),e))},0)}saveRegion(i){if(i.element){this.virtualAppend(i,this.regionsContainer,i.element),this.avoidOverlapping(i),this.regions.push(i);const t=[i.on("update",t=>{t||this.adjustScroll(i),this.emit("region-update",i,t)}),i.on("update-end",()=>{this.avoidOverlapping(i),this.emit("region-updated",i)}),i.on("play",t=>{var e;null!=(e=this.wavesurfer)&&e.play(i.start,t)}),i.on("click",t=>{this.emit("region-clicked",i,t)}),i.on("dblclick",t=>{this.emit("region-double-clicked",i,t)}),i.on("content-changed",()=>{this.emit("region-content-changed",i)}),i.once("remove",()=>{t.forEach(t=>t()),this.regions=this.regions.filter(t=>t!==i),this.emit("region-removed",i)})];this.subscriptions.push(...t),this.emit("region-created",i)}}addRegion(t){var e;if(!this.wavesurfer)throw Error("WaveSurfer is not initialized");const i=this.wavesurfer.getDuration(),n=null==(e=null==(e=this.wavesurfer)?void 0:e.getDecodedData())?void 0:e.numberOfChannels,s=new r(t,i,n);return this.emit("region-initialized",s),i?this.saveRegion(s):this.subscriptions.push(this.wavesurfer.once("ready",t=>{s._setTotalDuration(t),this.saveRegion(s)})),s}enableDragSelection(o,t=3){var e=null==(e=this.wavesurfer)?void 0:e.getWrapper();if(!(e&&e instanceof HTMLElement))return()=>{};let a=null,h=0;return i(e,(t,e,i)=>{a&&a._onUpdate(t,i>h?"end":"start")},t=>{var e,i,n,s;h=t,this.wavesurfer&&(e=this.wavesurfer.getDuration(),i=null==(i=null==(i=this.wavesurfer)?void 0:i.getDecodedData())?void 0:i.numberOfChannels,n=this.wavesurfer.getWrapper().getBoundingClientRect()["width"],s=t/n*e,t=(t+5)/n*e,a=new r(Object.assign(Object.assign({},o),{start:s,end:t}),e,i),this.emit("region-initialized",a),a.element&&this.regionsContainer.appendChild(a.element))},()=>{a&&(this.saveRegion(a),a=null)},t)}clearRegions(){this.regions.slice().forEach(t=>t.remove()),this.regions=[]}destroy(){this.clearRegions(),super.destroy(),this.regionsContainer.remove()}}export{o as default};